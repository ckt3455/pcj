<?php/** * 计划任务 */namespace console\controllers;use backend\models\Goods;use backend\models\Order;use backend\models\OrderDetail;use backend\models\ServiceOrder;use backend\models\Worker;use common\components\SzApi;use common\components\WdtClient;use Yii;use yii\console\Controller;use yii\web\Response;class ConsoleController extends Controller{    //定时查询派单信息    public function actionIndex(){        $orders = ServiceOrder::find()->where(['status'=>2,'is_pd'=>0])->all();        foreach ($orders as $k=>$v){            if($v->sz_order_number){                $data=[                    'order_number'=>$v->sz_order_number,                    'business_scene_type'=>7                ];                Yii::$app->response->format = Response::FORMAT_JSON;                try {                    $apiService = new SzApi();                    // 原始订单数据                    $orderData = $data;                    $result = $apiService->sendSecureRequest(                        'third_party_platform/orders/business_info',                        $orderData,                        Yii::$app->params['platform_code'], // 平台编码                        Yii::$app->params['public_key'] // RSA公钥                    );                    if ($result['http_code'] === 200) {                        if($result['response']['error_code']==1){                            $order_data=$result['response']['data'];                            if($order_data['order_distribute_info']){                                $v->is_pd=1;                                $v->worker_name=$order_data['order_distribute_info']['contact_name'];                                $v->worker_phone=$order_data['order_distribute_info']['contact_phone'];                                if($v->worker_phone){                                    $old=Worker::find()->where(['worker_phone'=>$v->worker_phone])->limit(1)->one();                                    if(!$old){                                        $new=new Worker();                                        $new->worker_phone=$v->worker_phone;                                        $new->worker_name=$v->worker_name;                                        if($new->save()){                                            $v->worker_id=$new->id;                                        }                                    }                                }                                if($v->save()){                                    echo $v->order_number.'派单成功';                                }                            }                        }                    }                } catch (\Exception $e) {                    echo '系统错误: ' . $e->getMessage();                }            }        }        echo '<br/>'.date('Y-m-d H:i:s');    }    //获取erp订单信息    public function actionOrder()    {        echo date('Y-m-d H:i:s');        $new = new WdtClient();        $new->appkey = Yii::$app->params['appkey'];        $new->appsecret = Yii::$app->params['appsecret'];        $new->sid = Yii::$app->params['sid'];        $new->gatewayUrl = 'https://sandbox.wangdian.cn/openapi2/stockout_order_query_trade.php';        $new->putApiParam('status', 55);        $end=date('Y-m-d H:i:s',time()-60);        $start=date('Y-m-d H:i:s',time()-10*24*3600);        $new->putApiParam('start_time', $start);        $new->putApiParam('end_time', $end);        $new->putApiParam('page_no', '0');        $new->putApiParam('page_size', '100');        $json = $new->wdtOpenApi();        $data_message = json_decode($json, true);        if ($data_message['code'] == 0) {            foreach ($data_message['stockout_list'] as $k => $v) {                $old=Order::find()->where(['order_number'=>$v['src_order_no']])->one();                if(!$old){                    $new=new Order();                    $new->order_number=$v['src_order_no'];                    $new->phone=$v['receiver_mobile'];                    $new->province=$v['receiver_province'];                    $new->city=$v['receiver_city'];                    $new->area=$v['receiver_district'];                    $new->money=$v['receivable'];                    $new->address=$v['receiver_address'];                    if(!$new->save()){                        echo '发生错误';                    }else{                        foreach ($v['details_list'] as $k1=>$v1){                            $new_detail=new OrderDetail();                            $new_detail->goods_title=$v1['goods_name'];                            $new_detail->order_id=$new->id;                            $new_detail->goods_code=$v1['goods_no'];                            $new_detail->number=intval($v1['goods_count']);                            if(!$new_detail->save()){                                $errors=$new_detail->getErrors();                                print_r($errors);                                $new->delete();                                break;                            }                        }                    }                }            }        }        echo 'success';        exit();    }}