<?phpnamespace backend\controllers;use backend\models\UserLevel;use backend\models\UserMoneyLog;use Yii;use backend\models\ProvinceUser;use yii\data\ActiveDataProvider;use yii\data\Pagination;use yii\helpers\Html;use yii\web\NotFoundHttpException;/** * ProvinceUserController implements the CRUD actions for ProvinceUser model. */class ProvinceUserController extends MController{    /**     * 首页     */    public function actionIndex()    {        //关联角色查询        $data   = ProvinceUser::find()->with(['cityMessage','areaMessage']);        $request  = Yii::$app->request;        $keyword=$request->get('keyword');        if(!empty($keyword)){            $data->andWhere(['or',['like','name',$keyword],['like','mobile_phone',$keyword]]);        }        $dataProvider = new ActiveDataProvider([            'query' => $data,            'sort' => [                'defaultOrder' => [                    'created_at' => SORT_DESC,                ]            ],        ]);        return $this->render('index',[            'keyword'=>$keyword,            'dataProvider'=>$dataProvider        ]);    }    /**     * 首页     */    public function actionExpertIndex()    {        //关联角色查询        $data   = ProvinceUser::find()->where(['<>', 'model', 0])->with(['cityMessage','areaMessage']);        $request  = Yii::$app->request;        $keyword=$request->get('keyword');        $type=$request->get('type');        if(!empty($keyword)){            $data->andWhere(['or',['like','name',$keyword],['like','phone',$keyword]]);        }        if(!empty($type)){            $data->andWhere(["model"=>$type]);        }        $pages  = new Pagination(['totalCount' =>$data->count(), 'pageSize' =>$this->_pageSize]);        $models = $data->offset($pages->offset)->orderBy('type desc,created_at desc')->limit($pages->limit)->all();        return $this->render('expert-index',[            'models'  => $models,            'pages'   => $pages,            'keyword'=>$keyword,            'type'    => $type        ]);    }    /**     * Displays a single ProvinceUser model.     * @param integer $id     * @return mixed     */    public function actionView($id)    {        return $this->render('view', [            'model' => $this->findModel($id),        ]);    }    /**     * 修改个人资料     */    public function actionPersonal()    {        $id       = Yii::$app->request->get('id');        $model    = $this->findModel($id);        $expert   =  Yii::$app->request->get('expert',0);        //提交表单        if ($model->load(Yii::$app->request->post()) && $model->save())        {            return $this->redirect(['personal','id'=>$id]);        }        return $this->render('personal', [            'model' => $model,            'expert'=>$expert        ]);    }    /**     * @return string|\yii\web\Response     * 编辑/新增     */    public function actionEdit()    {        $request  = Yii::$app->request;        $id       = $request->get('id');        $expert   = $request->get('expert',0);        $model    = $this->findModel($id);        if ($model->load(Yii::$app->request->post()) && $model->save())        {            return $this->render('/layer/close');        }        return $this->render('edit', [            'model' => $model,            'expert'=> $expert        ]);    }    public function actionDelete($id)    {        $this->findModel($id)->delete();        return $this->redirect(['index']);    }    /**     * @param $id     * @return null|static     * @throws NotFoundHttpException     * 返回模型     */    protected function findModel($id)    {        if (empty($id))        {            $model= new ProvinceUser();            return $model->loadDefaultValues();        }        $model=ProvinceUser::findOne($id);        if (empty($model))        {            return new ProvinceUser;        }        return $model;    }    /**     * @获取级别分类     * 返回模型     */    public function actionChild($type_id)    {        $model = UserLevel::getList($type_id);        $str = "--请选择二级--";        echo Html::tag('option',$str, ['value'=>'']) ;        foreach($model as $value=>$name)        {            echo Html::tag('option',Html::encode($name),array('value'=>$value));        }    }    /**     * 调整用户金额     */    public function actionChangeMoney(){        $id=Yii::$app->request->get('id');        $user=ProvinceUser::findOne($id);        if(Yii::$app->request->post()){            $post=Yii::$app->request->post();            if($post['status']==1){                $user->money+=$post['money'];            }            if($post['status']==2){                $user->money-=$post['money'];            }            if($user->save()){                $log=new UserMoneyLog();                $log->setAttributes($post);                $log->user_id=$user->id;                $log->created_at=time();                $log->admin_id=Yii::$app->user->id;                $log->save();                return $this->render('/layer/close');            }        }        return $this->render('change-money', [            'user' => $user,        ]);    }    public function actionApply(){        $data=ProvinceUser::find()->where(['is_rz'=>0,'is_apply'=>0])->andWhere(['<>','license','']);        $pages  = new Pagination(['totalCount' =>$data->count(), 'pageSize' =>$this->_pageSize]);        $models = $data->offset($pages->offset)->orderBy('created_at desc')->limit($pages->limit)->all();        return $this->render('apply',[            'models'  => $models,            'pages'   => $pages,        ]);    }    public function actionUserApply(){        $id=Yii::$app->request->get('id');        $model=ProvinceUser::findOne($id);        if(Yii::$app->request->post()){            $post=Yii::$app->request->post();            if($post['status']==1){                $model->is_rz=1;            }            if($post['status']==2){                $model->is_apply=2;            }            if($model->save()){                return $this->render('/layer/close');            }        }        return $this->render('user-apply',['model'=>$model]);    }}