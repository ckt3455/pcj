<?phpnamespace backend\models;use common\components\Helper;use common\models\User;use Yii;use yii\behaviors\TimestampBehavior;use yii\db\Exception;/** * This is the model class for table "{{%order}}". * * @property integer $id * @property integer $type * @property string $order_number * @property integer $user_id * @property string $consignee * @property string $phone * @property integer $address_id * @property string $address_detail * @property integer $invoice_id * @property integer $express * @property double $total_price * @property integer $pay_method * @property integer $pay_status * @property integer $status * @property string $content * @property integer $append * @property integer $updated * @property integer $paid_time * @property integer $delivery_time * @property integer $confirm_time * @property integer $is_delete * @property integer $category * @property string $freight * @property string $province * @property string $city * @property string $area * @property string $service_price * @property integer $integral * @property integer $is_delivery * @property string $other_money * @property string $invoice_company * @property string $invoice_number * @property string $invoice_address * @property string $invoice_phone * @property string $invoice_bank * @property string $invoice_username * @property string $weight * @property string $pay_price * @property integer $service_id * @property string $experience * @property string $express_number */class Order extends \yii\db\ActiveRecord{    /**     * @inheritdoc     */    public static function tableName()    {        return '{{%order}}';    }    public function behaviors()    {        return [            TimestampBehavior::className(),        ];    }    //订单类型    public static $type = [        1 => '普通',    ];    //订单状态    public static $status = [        '1' => '待付款',        '2' => '待发货',        '3' => '待收货',        '4' => '退款退货',        '5' => '已完成',        '-1' => '已取消',//        '-2'=>'已关闭'    ];    public static $pay_message=[        1=>'线上',        2=>'线下'    ];    /**     * @inheritdoc     */    public function rules()    {        return [            [['type', 'user_id', 'pay_method', 'pay_status', 'status', 'create_at', 'updated_at', 'invoice_id', 'address_id', 'category','express','service_id'], 'integer'],            [['user_id'], 'required'],            [['order_number', 'phone'], 'string', 'max' => 50],            [['consignee', 'address_detail','express_number','province','city','area','express_name'], 'string', 'max' => 255],            [['content'], 'string'],            [['total_price', 'other_money', 'service_price','pay_price','freight','experience'], 'number']        ];    }    /**     * @inheritdoc     */    public function attributeLabels()    {        return [            'id' => 'ID',            'type' => '类型',            'order_number' => '订单号',            'user_id' => '用户',            'total_price' => '总价',            'pay_method' => '支付方式',            'pay_status' => '支付状态',            'status' => '状态',            'created_at' => '下单时间',            'updated_at' => '更新时间',            'content' => '备注',            'invoice_id' => '发票',            'express' => '配送方式',            'address_id' => '地址',            'consignee' => '收货人',            'phone' => '电话',            'address_detail' => '地址',            'category' => '是否预购',            'is_delivery' => '发货状态',            'freight' => '配送费',            'other_money' => '订单金额调整(-3表示优惠3元,3表示加价3元)',            'service_price' => '服务费',            'integral' => '订单积分',            'province' => '省',            'city' => '市',            'area' => '区',            'invoice_company' => '发票单位名称',            'invoice_number' => '发票识别号',            'invoice_address' => '发票注册地址',            'invoice_phone' => '发票电话',            'invoice_bank' => '发票银行',            'invoice_username' => '发票帐号',            'pay_price'=>'总价',            'service_id'=>'客服',            'experience'=>'经验',            'express_number'=>'快递单号',            'express_name'=>'快递名称',            'image'=>'付款图片'        ];    }    /**     * @param bool $insert     * @return bool     * 自动插入     */    public function beforeSave($insert)    {        if ($this->isNewRecord) {            $this->order_number = date('YmdHis', time()) . $this->user_id.mt_rand(1000,9999);        }        return parent::beforeSave($insert);    }    /**     * 关联用户     */    public function getUser()    {        return $this->hasOne(User::className(), ['id' => 'user_id']);    }    /**     * 关联地址     */    public function getAddress()    {        return $this->hasOne(Address::className(), ['id' => 'address_id']);    }    /**     * 关联订单详情     */    public function getDetail()    {        return $this->hasMany(OrderDetail::className(), ['order_id' => 'id']);    }    /**     * 关联发票     */    public function getInvoice()    {        return $this->hasOne(OrderInvoice::className(), ['order_number' => 'order_number']);    }    /**     * 添加订单     * $user_id 用户id $sku     * $sku 二维数组 $sku[2]=1 掉表id为2的sku数量为1个,当为特殊订单时，sku表示报价单的详情     * $address_id 地址id     * $invoice_id  地址id     * $express 快递方式     * $pay_method 支付方式     * $content 备注     */    public static function addOrder($user_id, $sku, $address_id,  $pay_method, $content,$invoice_id, $type = 1, $category = 0)    {        //创建事物        $tr = Yii::$app->db->beginTransaction();        try {            $order = new Order();            $order->address_id = $address_id;            $order->invoice_id=$invoice_id;            $address = Address::findOne($address_id);            $order->user_id = $user_id;            $order->consignee = $address->user;            $order->phone = $address->phone;            $order->category = $category;            $order->pay_method = $pay_method;            $order->content = $content;            $order->address_detail =  $address->content;            $order->province=$address->province;            $order->city=$address->city;            $order->area=$address->area;            $order->type=$type;            if(!$order->save()){                $error=$order->getFirstErrors();                $message=reset($error);                throw new Exception($message);//抛出异常            }            $model = Order::findOne($order->id);            //普通订单            if ($type == 1) {                $price = 0;                foreach ($sku as $k => $v) {                    if($v>0){                        $detail = new OrderDetail();                        $detail->order_id = $order->id;                        $detail->number = $v;                        $sku = GoodsOption::findOne($k);                        if(!($sku->goods)){                            throw new Exception('规格没有所属产品');//抛出异常                        }                        $detail->title = $sku->goods->title;                        $detail->order_number=$order->order_number;                        $detail->order_id=$order->id;                        $detail->goods_id = $sku->goods->id;                        $detail->sku_id = $k;                        $detail->price = $sku->price;                        if(!$detail->save()){                            $error=$detail->getFirstErrors();                            $message=reset($error);                            throw new Exception($message);//抛出异常                        }                        $price +=  $detail->price * $v;                    }                }                $model->total_price = $price;                if (!$model->save()) {                    $error=$model->getFirstErrors();                    $message=reset($error);                    throw new Exception($message);//抛出异常                };            }            //$model->experience=($model->total_price)*Yii::$app->config->info('WEB_EXP_NUMBER')/100;//经验            $model->integral=($model->total_price)*Yii::$app->config->info('WEB_INTEGRAL_CONVERSION')/100;//经验            if (!$model->save()) {                throw new Exception('订单保存失败');//抛出异常            }            $tr->commit();            return $order->id;        } catch (yii\db\Exception $e) {            //回滚            return false;        }    }    /**     * 改变订单状态     */    public static function changeOrderStatus($order_id, $user_id, $status)    {        Switch ($status) {            //取消订单,只有未付款的订单可以取消            case -1:                $order = Order::find()->where(['user_id' => $user_id, 'id' => $order_id, 'status' => 0])->limit(1)->one();                $order->status = $status;                $order->save();                break;            case 1;                //确认用户付款                $order = Order::find()->where(['user_id' => $user_id, 'id' => $order_id, 'status' => 0])->one();                break;            case 2;                //确认发货                $order = Order::find()->where(['user_id' => $user_id, 'id' => $order_id, 'status' => 1])->one();                //减少对应的sku库存                if (StockRecord::is_paid($order->id)) {                    $order->status = 1;                    $order->pay_status = 1;                    $order->paid_time = time();                    $order->save();                };                $order->delivery_time = time();                $order->status = 2;                $order->save();                break;            case 3;                //确认收货                $order = Order::find()->where(['user_id' => $user_id, 'id' => $order_id, 'status' => 2])->one();                if($order){                    if(Order::finishOrder($order->id)){                        return true;                    }else{                        return false;                    }                }                break;        }    }    /**     * 确认收货     */    public static function finishOrder($order_id){        $order=Order::findOne($order_id);        if($order->status==3){            $order->confirm_time = time();            $order->status = 5;            $user=ProvinceUser::findOne($order->user_id);            $user->integral+=$order->integral;            if(!$user->save()){                print_r($user->getFirstErrors());exit;            }            $order->save();            return true;        }else{            return false;        }    }    //关联配送方式    public function getFreightMessage(){        return $this->hasOne(FreightModel::className(),['id'=>'express']);    }    //关联客服    public function getServer(){        return $this->hasOne(Server::className(),['id'=>'service_id']);    }    public function getProvince(){        if($this->province_id){            $model=Provinces::findOne($this->province_id);            return $model->areaname;        }else{            return '';        }    }    public function getCity(){        if($this->city_id){            $model=Provinces::findOne($this->city_id);            return $model->areaname;        }else{            return '';        }    }    public function getArea(){        if($this->area_id){            $model=Provinces::findOne($this->area_id);            return $model->areaname;        }else{            return '';        }    }    public function getExpressName(){        if($this->express){            $freight=FreightModel::findOne($this->express);            if($freight){                return $freight->title;            }        }        return '';    }}