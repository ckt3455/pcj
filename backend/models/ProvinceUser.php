<?phpnamespace backend\models;use common\components\Helper;use Yii;use yii\helpers\ArrayHelper;/** * This is the model class for table "{{%province_user}}". * * @property integer $id * @property integer $parent_id * @property string $name * @property string $mobile_phone * @property string $email * @property integer $birthday * @property integer $sex * @property string $company * @property string $company_nature * @property string $industry * @property integer $provinces * @property integer $city * @property integer $area * @property string $street * @property integer $type * @property integer $user_level * @property string $username * @property string $password_hash * @property string $auth_key * @property string $head * @property integer $created_at * @property integer $updated_at * @property integer $last_time * @property string $qq * @property string $model * @property string $skilled * @property string $phone * @property string $weixin * @property integer $integral * @property integer $experience * @property double $money * @property double $money_paid * @property integer $service_id * @property string $license * @property integer $start_time * @property integer $end_time * @property integer $is_month * @property string $money_year * @property integer $is_apply */class ProvinceUser extends \yii\db\ActiveRecord{    const sex_1 = 1;//男    const sex_2 = 2;//女    const sex_3 = 3;//未知    const type_1 = 1;//普通用户    const type_2 = 2;//经销会员    const type_3 = 3;//合作会员    public static $type = [        1 => "终端会员",        2 => "经销会员",        3 => "合作会员",    ];    public $repassword;//重复密码    public $register_type;//注册类型    public $code;//手机验证码    public $code_email;//邮箱验证码    public static function tableName()    {        return '{{%province_user1}}';    }    /**     * @inheritdoc     */    public function rules()    {        return [            [['username', 'password_hash'], 'required'],            [['created_at', 'updated_at', 'provinces','type','sex','model','last_time','is_month','is_apply'], 'integer'],            [['name', 'username', 'qq', 'weixin', 'phone','company_phone'], 'string', 'max' => 50],            [['username'], 'unique','message'=>'用户账户已经占用'],            [['email'], 'unique','message'=>'邮箱已存在'],            [['mobile_phone'], 'unique','message'=>'手机号码已存在'],            [['password_hash','head','company','street','company_nature','industry','credit_code'], 'string', 'max' => 255],            [['skilled'], 'string', 'max' => 500],            [['auth_key'], 'string', 'max' => 32],            [['birthday'], 'safe'],            [['email'],'email'],            [['email','company_number','contact','position','id_card'], 'string', 'max' => 50],            ['mobile_phone','match','pattern'=>'/^[1][3578][0-9]{9}$/','message'=>'不是一个有效的手机号码'],            [['city','area','parent_id','model','user_level','service_id'], 'default', 'value' => '0'],            [['money','money_paid','money_year'],'double'],            ['repassword','validateRepassword','on'=>'register'],            ['code','validateType','on'=>'register'],            ['company','validateCompany','on'=>'register'],            [['code','code_email','start_time','end_time'],'safe'],            [['type'],'default','value'=>1],            [['experience','integral'],'number']        ];    }    /**     * @inheritdoc     */    public function attributeLabels()    {        return [            'id' => 'ID',            'name' => '昵称',            'provinces' => '省',            'username' => '用户名',            'password_hash' => '密码',            'birthday'=>'生日',            'head'=>'头像',            'city'=>'市',            'area'=>'区',            'type'=>'会员类型',            'sex'=>'性别',            'mobile_phone'=>'手机号码',            'email'=>'电子邮箱',            'model'=>'专家类型',            'skilled'=>'擅长领域',            'phone'=>'联系电话',            'weixin'=>'微信',            'qq'=>'QQ',            'parent_id'=>'上级用户',            'auth_key' => 'Auth Key',            'created_at' => '注册时间',            'updated_at' => 'Updated At',            'last_time'=>'上次登录时间',            'company'=>'公司名称',            'user_level'=>'会员级别',            'integral'=>'积分',            'experience'=>'经验',            'money'=>'预存款金额',            'money_paid'=>'已消费',            'street'=>'街道',            'service_id'=>'客服',            'repassword'=>'确认密码',            'code'=>'验证码',            'code_email'=>'验证码',            'start_time'=>'生效开始日期',            'end_time'=>'生效结束日期',            'company_nature'=>'单位性质',            'industry'=>'所属行业',            'is_month'=>'是否开通月结',            'money_year'=>'年采购金额',            'company_phone'=>'联系手机',            'license'=>'营业执照',            'id_card'=>'身份证',            'position'=>'职位',            'contact'=>'账号管理人姓名',            'company_number'=>'坤远官网账号',            'credit_code'=>'统一社会信用代码'        ];    }    public function validateType($attribute)    {        if ($this->username=== ''){            $this->addError('mobile_phone', "手机号码必填.");        }else{            if($this->code){                $re = Helper::checkSMS($this->username, $this->code);                if($re['error']!==0){                    $this->addError('code', $re['message']);                }            }else{                $this->addError('code', "请填写验证码");            }        }    }    public function validateRepassword($attribute){        if(!$this->repassword){            $this->addError($attribute, "请再次输入密码.");        }        if($this->password_hash!==$this->repassword){            $this->addError($attribute, "2次输入的密码不一致.");        }    }    public function validateCompany($attribute)    {        if ($this->type== 2)        {            if ($this->company=== '')                $this->addError('company', "公司名称必填");        }    }    /**     * @param bool $insert     * @return bool     * 自动插入     */    public function beforeSave($insert)    {        if($this->isNewRecord)        {            $this->password_hash = Yii::$app->security->generatePasswordHash($this->password_hash);            $this->auth_key   = Yii::$app->security->generateRandomString();            $this->created_at=time();            $this->birthday=strtotime($this->birthday);            if($this->name==''){                $this->name='会员';            }            //随机取一个客服//            $service=Server::find()->where(['type'=>2])->select('id')->asArray()->all();//            $count=count($service);//            $rand=rand(0,$count-1);//            $this->service_id=$service[$rand]['id'];        }        else        {            //验证密码是否修改            $user=ProvinceUser::findOne($this->id);            $old_pwd = $user->password_hash;            $new_pwd = $this->password_hash;            if($old_pwd != $new_pwd)            {                $this->password_hash = Yii::$app->security->generatePasswordHash($this->password_hash);            }            if(!is_numeric($this->birthday)) {                $this->birthday = strtotime($this->birthday);            }            $this->updated_at=time();        }        if(empty($this->name)){            $this->name = $this->username;        }        if(!is_numeric($this->start_time) and $this->start_time){            $this->start_time=strtotime($this->start_time);        }        if(!is_numeric($this->end_time) and  $this->end_time){            $this->end_time=strtotime($this->end_time);        }        return parent::beforeSave($insert);    }    /**     * 关联省     */    public function getProvinceMessage(){        return $this->hasOne(Provinces::className(), ['id' => 'provinces']);    }    /**     * 关联市     */    public function getCityMessage(){        return $this->hasOne(Provinces::className(), ['id' => 'city']);    }    /**     * 关联区     */    public function getAreaMessage(){        return $this->hasOne(Provinces::className(), ['id' => 'area']);    }    /**     * 用户等级     */    public function getLevel(){        return $this->hasOne(UserLevel::className(), ['id' => 'user_level']);    }    public static function getName($id){        $one = ProvinceUser::find()->where(['id'=>$id])->asArray()->One();        if($one)        {            if($one['name'])            {                return $one['name'];            }else            {                return $one['username'];            }        }else        {            return '用户不存在';        }    }    public static function getExpertUser(){        $type = ExpertType::find()->where(['status'=>1])->orderBy('sort asc, id desc')->asArray()->all();        $typein = array();        foreach ($type as $k => $v) {            $typein[]= $v['id'];            $typearr[$v['id']] = $v;        }        $data = ProvinceUser::find()->where(['model'=>$typein])->asArray()->all();        $arr = array();        foreach ($data as $k => $v) {            $arr[$typearr[$v['model']]['name']][]=$v;        }        return $arr;    }    public static function getList($where){        $model=ProvinceUser::find()->where($where)->asArray()->all();        return ArrayHelper::map($model,'id','name');    }    public function getService(){        return $this->hasOne(Server::className(),['id'=>'service_id']);    }    public function getDefault(){        $model=UserLevel::find()->where(['experience'=>0,'type'=>1])->one();        if($model){            return $model->id;        }else{            return 0;        }    }    //获取用户头像    public function getHeadImage(){        if($this->head){            return $this->head;        }else{            return '/Public/frontend/images/head.png';        }    }    //用户有效期    public function getTimeValid(){        if($this->end_time>0){            if($this->end_time<time()){                return '已过期';            }else{                return date('Y-m-d',$this->start_time).'—'.date('Y-m-d',$this->end_time);            }        }else{            return '-';        }    }}