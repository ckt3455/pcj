<?phpnamespace frontend\controllers;use backend\models\Address;use backend\models\Cart;use backend\models\Goods;use backend\models\GoodsComments;use backend\models\News;use backend\models\Order;use backend\models\OrderComments;use backend\models\OrderDetail;use backend\models\OrderPay;use backend\models\OrderRefund;use backend\models\ProvinceUser;use backend\models\SetImage;use backend\models\Sku;use backend\models\UploadForm;use backend\models\User;use backend\models\UserAddress;use backend\models\UserInvoice;use common\components\Helper;use common\components\Pay;use common\components\WxApi;use Yii;use yii\data\Pagination;use yii\filters\AccessControl;use yii\web\UploadedFile;/** * Index controller */class OrderController extends FController{    public function init()    {        parent::init();        // 检查用户是否已经登录        if (!Yii::$app->session->get('user_id')) {            // 用户未登录，执行某些操作，比如重定向到登录页面            $url = \yii\helpers\Url::to('/index.php/index/login.html', true);            return $this->redirect($url);        }        // 用户已登录，继续执行其他初始化操作    }    public function actionBuy(){        Yii::$app->session->set('form_session', Helper::random(6));        $session=Yii::$app->session->get('form_session');        $goods_id=Yii::$app->request->get('id');        $goods=Goods::findOne($goods_id);        $user_id=Yii::$app->session->get('user_id');        $address=Address::find()->where(['user_id'=>$user_id])->orderBy('is_default desc,id asc')->all();        return $this->render('buy',['address'=>$address,'goods'=>$goods,'session'=>$session]);    }    public function actionAddImage(){        if (isset($_FILES['image']['name']) && $_FILES['image']['size'] > 0) {            // 定义允许上传的文件类型            $allowedTypes = array('image/jpg','image/jpeg','image/png');            // 定义文件上传路径            $uploadPath = 'uploads/';            $videoTmpName = $_FILES['video']['tmp_name'];            $videoSize = $_FILES['video']['size'];            $arr_name=explode('.',$videoTmpName);            $size = round($videoSize / 1024 / 1024);            if ($size > 5) {                return $this->message('仅支持5M以内的图片', $this->redirect(Yii::$app->request->referrer));            }            $videoType = $_FILES['video']['type'];            $name = date('YmdHis') . Helper::random(6);            $arr_name=explode('.',$_FILES['video']['name']);            $videoName = $name .'.'. $arr_name[1];            // 检查文件类型            if (in_array($videoType, $allowedTypes)) {                // 移动文件到指定目录                move_uploaded_file($videoTmpName, $uploadPath . $videoName);                $url='/' . $uploadPath . $videoName;                return $url;            } else {                return $this->message('不允许的文件类型', $this->redirect(Yii::$app->request->referrer));            }        } else {            return $this->message('没有文件上传', $this->redirect(Yii::$app->request->referrer));        }    }    public function actionBuy2(){        $goods_id=Yii::$app->request->get('id');        $goods=Goods::findOne($goods_id);        Yii::$app->session->set('form_session', Helper::random(6));        $session=Yii::$app->session->get('form_session');        $user_id=Yii::$app->session->get('user_id');        $address=Address::find()->where(['user_id'=>$user_id])->orderBy('is_default desc,id asc')->all();        return $this->render('buy2',['address'=>$address,'goods'=>$goods,'session'=>$session]);    }    public function actionBuy3(){        $goods_id=Yii::$app->request->get('id');        $goods=Goods::findOne($goods_id);        Yii::$app->session->set('form_session', Helper::random(6));        $session=Yii::$app->session->get('form_session');        $user_id=Yii::$app->session->get('user_id');        $old_order=Order::find()->where(['user_id'=>$user_id])->andWhere(['>=','status',2])->limit(1)->one();        if($old_order){            return $this->message('绿色积分区,只有首单可购买', $this->redirect(Yii::$app->request->referrer));        }        $address=Address::find()->where(['user_id'=>$user_id])->orderBy('is_default desc,id asc')->all();        return $this->render('buy3',['address'=>$address,'goods'=>$goods,'session'=>$session]);    }    public function actionAddOrder(){        $post=Yii::$app->request->post();        $session = Yii::$app->request->post('form_session');        if ($session == Yii::$app->session->get('form_session')) {            Yii::$app->session->set('form_session', Helper::random(6));            if (isset($post['image']) and $post['image']) {                $image = Helper::base64_image_content($post['image']);                if (!$image) {                    return $this->message('请上传付款截图', $this->redirect(Yii::$app->request->referrer));                }            } else {                return $this->message('请上传付款截图', $this->redirect(Yii::$app->request->referrer));            }            if (!$post['address_id']) {                return $this->message('请填写地址', $this->redirect(Yii::$app->request->referrer));            }            $re = Order::add_order(Yii::$app->session->get('user_id'), $post['good_id'], $post['number'], $post['address_id'], $post['content'], $image);            if ($re['error'] == 0) {                return $this->redirect(['order/index']);            } else {                return $this->message($re['message'], $this->redirect(Yii::$app->request->referrer));            }        }else{            return $this->message('请不要重复提交', $this->redirect(['order/index']));        }    }    //积分订单    public function actionAddOrder2(){        $post=Yii::$app->request->post();        $session = Yii::$app->request->post('form_session');        if ($session == Yii::$app->session->get('form_session')) {            Yii::$app->session->set('form_session', Helper::random(6));            if (!$post['address_id']) {                return $this->message('请填写地址', $this->redirect(Yii::$app->request->referrer));            }            $re = Order::add_order2(Yii::$app->session->get('user_id'), $post['good_id'], $post['number'], $post['address_id'], $post['content']);            if ($re['error'] == 0) {                return $this->redirect(['order/index2']);            } else {                return $this->message($re['message'], $this->redirect(Yii::$app->request->referrer));            }        }else{            return $this->message('请不要重复提交', $this->redirect(['order/index2']));        }    }    //绿色积分区订单    public function actionAddOrder4(){        $post=Yii::$app->request->post();        $session = Yii::$app->request->post('form_session');        if ($session == Yii::$app->session->get('form_session')) {            Yii::$app->session->set('form_session', Helper::random(6));            if (!$post['address_id']) {                return $this->message('请填写地址', $this->redirect(Yii::$app->request->referrer));            }            if (isset($post['image']) and $post['image']) {                $image = Helper::base64_image_content($post['image']);                if (!$image) {                    return $this->message('请上传付款截图', $this->redirect(Yii::$app->request->referrer));                }            } else {                return $this->message('请上传付款截图', $this->redirect(Yii::$app->request->referrer));            }            $re = Order::add_order4(Yii::$app->session->get('user_id'), $post['good_id'], $post['number'], $post['address_id'], $post['content'],$image);            if ($re['error'] == 0) {                return $this->redirect(['order/index']);            } else {                return $this->message($re['message'], $this->redirect(Yii::$app->request->referrer));            }        }else{            return $this->message('请不要重复提交', $this->redirect(['order/index2']));        }    }    //购物车结算    public function actionAddOrder3(){        $post=Yii::$app->request->post();        $session = Yii::$app->request->post('form_session');        if ($session == Yii::$app->session->get('form_session')) {            if (!$post['address_id']) {                return $this->message('请填写地址', $this->redirect(Yii::$app->request->referrer));            }            $image = '';            if (isset($post['image']) and $post['image']) {                $image = Helper::base64_image_content($post['image']);                if (!$image) {                    $image = '';                    return $this->message('请上传付款截图', $this->redirect(Yii::$app->request->referrer));                }            } else {                return $this->message('请上传付款截图', $this->redirect(Yii::$app->request->referrer));            }            $re = Order::add_order3(Yii::$app->session->get('user_id'), $post['cart'], $post['address_id'], $post['content'], $image);            if ($re['error'] == 0) {                return $this->redirect(['order/index']);            } else {                return $this->message($re['message'], $this->redirect(['cart/index']));            }        }else{            return $this->message('请不要重复提交', $this->redirect(['order/index']));        }    }    public function actionIndex(){//        Order::updateAll(['status'=>-1],['and',['<=','created_at',time()-7200],['in','type',[1,3]],['status'=>1]]);        $status=Yii::$app->request->get('status','');        $keywords=Yii::$app->request->get('keywords','');        $order=Order::find()->where(['user_id'=>Yii::$app->session->get('user_id')])            ->andWhere(['in','type',[1,3,4]])            ->andFilterWhere(['status'=>$status])->andFilterWhere(['like','order_number',$keywords])->orderBy('id desc')->all();        return $this->render('index',['order'=>$order]);    }    public function actionIndex2(){        $status=Yii::$app->request->get('status','');        $keywords=Yii::$app->request->get('keywords','');        $order=Order::find()->where(['user_id'=>Yii::$app->session->get('user_id'),'type'=>2])            ->andFilterWhere(['status'=>$status])->andFilterWhere(['like','order_number',$keywords])->orderBy('id desc')->all();        return $this->render('index2',['order'=>$order]);    }    public function actionDetail(){//        Order::updateAll(['status'=>-1],['and',['<=','created_at',time()-7200],['in','type',[1,3]],['status'=>1]]);        $id=Yii::$app->request->get('id');        $order=Order::findOne($id);        if($order['user_id']==Yii::$app->session->get('user_id')){            return $this->render('detail',['order'=>$order]);        }else{            return  $this->message('不是您的订单',$this->redirect(Yii::$app->request->referrer));        }    }    public function actionDetail2(){        $id=Yii::$app->request->get('id');        $order=Order::findOne($id);        if($order['user_id']==Yii::$app->session->get('user_id')){            return $this->render('detail2',['order'=>$order]);        }else{            return  $this->message('不是您的订单',$this->redirect(Yii::$app->request->referrer));        }    }    public function actionCancel(){        $id=Yii::$app->request->get('id');        $order=Order::findOne($id);        if($order->status!=1){            return $this->message('订单状态不正确',$this->redirect(Yii::$app->request->referrer));        }else{            if($order->user_id==Yii::$app->session->get('user_id')){                $order->status=-1;                $order->save();                return $this->redirect(Yii::$app->request->referrer);            }else{                return $this->message('不是你的订单',$this->redirect(Yii::$app->request->referrer));            }        }    }    public function actionFinish($id)    {        $order = Order::findOne($id);        if ($order->status == 3) {            $order->status = 4;            $order->finish_time = time();            $order->save();            return $this->message('成功', $this->redirect(Yii::$app->request->referrer), 'success');        } else {            return $this->message('发生错误', $this->redirect(Yii::$app->request->referrer), 'error');        }    }}