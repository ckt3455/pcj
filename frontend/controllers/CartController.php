<?phpnamespace frontend\controllers;use AlibabaCloud\Chatbot\V20171011\Chat;use backend\models\Address;use backend\models\Cart;use backend\models\Goods;use backend\models\User;use backend\models\UserCart;use Yii;use yii\helpers\Url;/** * Index controller */class CartController extends FController{    public function init()    {        parent::init();        // 检查用户是否已经登录        if (!Yii::$app->session->get('user_id')) {            // 用户未登录，执行某些操作，比如重定向到登录页面            $url = \yii\helpers\Url::to('/index.php/index/login.html', true);            return $this->redirect($url);        }        // 用户已登录，继续执行其他初始化操作    }    public function actionAddCart(){        if (!Yii::$app->session->get('user_id')) {            // 用户未登录，执行某些操作，比如重定向到登录页面            $url = \yii\helpers\Url::to('/index.php/index/login.html', true);            return $this->redirect($url);        }        $id=Yii::$app->request->get('id');        $old=UserCart::find()->where(['goods_id'=>$id,'user_id'=>Yii::$app->session->get('user_id')])->limit(1)->one();        if($old){            $old->number+=1;            if($old->save()){                return $this->message('加入购物车成功',$this->redirect(Yii::$app->request->referrer));            }else{                return $this->message('加入购物车失败',$this->redirect(Yii::$app->request->referrer));            }        }else{            $new=new UserCart();            $new->user_id=Yii::$app->session->get('user_id');            $new->goods_id=$id;            $new->number=1;            if($new->save()){                return $this->message('加入购物车成功',$this->redirect(Yii::$app->request->referrer));            }else{                return $this->message('加入购物车失败',$this->redirect(Yii::$app->request->referrer));            }        }    }    public function actionIndex(){        $model=UserCart::find()->where(['user_id'=>Yii::$app->session->get('user_id')])->orderBy('id desc')->all();        return $this->render('index',['model'=>$model]);    }    public function actionNumber(){        $type=Yii::$app->request->get('type',1);        $id=Yii::$app->request->get('id');        $cart=UserCart::findOne($id);        if($type==1){            $goods=Goods::findOne($cart->goods_id);            if($goods->number>$cart->number){                $cart->number++;                $cart->save();                return $this->redirect(Yii::$app->request->referrer);            }else{                return $this->message('库存不足',$this->redirect(Yii::$app->request->referrer));            }        }else{            if($cart->number>1){                $cart->number--;                $cart->save();                return $this->redirect(Yii::$app->request->referrer);            }else{                return $this->redirect(Yii::$app->request->referrer);            }        }    }    public function actionDelete(){        $id=Yii::$app->request->get('id');        if(!$id){            return $this->message('请选择要删除的数据',$this->redirect(Yii::$app->request->referrer));        }else{            $arr=explode(',',$id);            foreach ($arr as $k=>$v){                $model=UserCart::findOne($v);                if($model and $model->user_id==Yii::$app->session->get('user_id')){                    $model->delete();                }            }        }        return $this->redirect(['index']);    }    public function actionAddOrder(){        $user = User::findOne(Yii::$app->session->get('user_id'));        $post=Yii::$app->request->post();        if(!isset($post['cart_id'])){            return $this->message('请选择要结算的商品',$this->redirect(Yii::$app->request->referrer));        }else{            $cart=UserCart::find()->where(['in','id',$post['cart_id']])->andWhere(['user_id'=>$user['id']])->all();            $cart_id=implode(',',$post['cart_id']);            $address=Address::find()->where(['user_id'=>$user['id']])->orderBy('is_default desc,id asc')->all();            $money=0;            foreach ($cart as $k=>$v){                $money+=$v->goods['price']*$v['number'];            }            return $this->render('buy',['cart'=>$cart,'cart_id'=>$cart_id,'address'=>$address,'money'=>$money]);        }    }}