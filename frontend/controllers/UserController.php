<?phpnamespace frontend\controllers;use backend\models\Address;use backend\models\IntLog;use backend\models\Order;use backend\models\SetImage;use backend\models\User;use backend\models\UserCard;use backend\models\UserCart;use backend\models\UserHistory;use backend\models\UserLevel;use backend\models\UserRead;use backend\models\UserRelation;use backend\models\UserRelation2;use common\components\Helper;use dosamigos\qrcode\QrCode;use Yii;/** * Index controller */class UserController extends FController{    public function init()    {        parent::init();        // 检查用户是否已经登录        if (!Yii::$app->session->get('user_id')) {            // 用户未登录，执行某些操作，比如重定向到登录页面            $url = \yii\helpers\Url::to('/index.php/index/login.html', true);            return $this->redirect($url);        }        // 用户已登录，继续执行其他初始化操作    }    //用户提现    public function actionApply()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        return $this->render('apply', ['user' => $user]);    }    public function actionIndex()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        $number1=Order::find()->where(['user_id'=>$user['id'],'status'=>1])->andWhere(['in','type',[1,3]])->count()*1;        $number2=Order::find()->where(['user_id'=>$user['id'],'status'=>2])->andWhere(['in','type',[1,3]])->count()*1;        $number3=Order::find()->where(['user_id'=>$user['id'],'status'=>3])->andWhere(['in','type',[1,3]])->count()*1;        $number4=Order::find()->where(['user_id'=>$user['id'],'status'=>4])->andWhere(['in','type',[1,3]])->count()*1;        $number5=Order::find()->where(['user_id'=>$user['id'],'status'=>-1])->andWhere(['in','type',[1,3]])->count()*1;        $message=SetImage::getList(['type'=>3]);        $un_read=0;        foreach ($message as $k=>$v){            $old=UserRead::find()->where(['user_id'=>$user['id'],'message_id'=>$v['id']])->limit(1)->one();            if(!$old){                $un_read++;            }        }        return $this->render('index', ['user' => $user,'number1'=>$number1,'number2'=>$number2,'number3'=>$number3,'number4'=>$number4,'number5'=>$number5,'un_read'=>$un_read]);    }    public function actionMessage(){        $user = User::findOne(Yii::$app->session->get('user_id'));        $message=SetImage::getList(['type'=>3]);        foreach ($message as $k=>$v){            $old=UserRead::find()->where(['user_id'=>$user['id'],'message_id'=>$v['id']])->limit(1)->one();            if(!$old){                $new=new UserRead();                $new->user_id=$user['id'];                $new->message_id=$v['id'];                $new->save();            }        }        return $this->render('message', ['user' => $user,'message'=>$message]);    }    public function actionMessageDetail(){        $user = User::findOne(Yii::$app->session->get('user_id'));        $id=Yii::$app->request->get('id');        $model=SetImage::findOne($id);        $old=UserRead::find()->where(['user_id'=>$user['id'],'message_id'=>$model['id']])->limit(1)->one();        if(!$old){            $new=new UserRead();            $new->user_id=$user['id'];            $new->message_id=$model['id'];            $new->save();        }        return $this->render('message-detail', ['user' => $user,'model'=>$model]);    }    public function actionPassword(){        $user = User::findOne(Yii::$app->session->get('user_id'));        return $this->render('password', ['user' => $user]);    }    public function actionPassword2()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        $data = [            'error' => 1,            'message' => ''        ];        if (Yii::$app->request->post()) {            $post = Yii::$app->request->post();            $sms = $post['sms'];            $password = $post['password'];            $re_password = $post['re_password'];            if (!$sms) {                $data['message'] = '请填写验证码';                return json_encode($data);            }            if (!$password) {                $data['message'] = '请填写密码';                return json_encode($data);            }            if ($password != $re_password) {                $data['message'] = '两次输入的密码不一致';            }            $re = Helper::checkSMS($user['mobile'], $sms);            if ($re['error'] == 0) {                    $user->password = $password;                    if (!$user->save()) {                        $errors = $user->getFirstErrors();                        $data['message'] = reset($errors);                    } else {                        $data['error'] = 0;                    }            } else {                $data['message'] = $re['message'];            }        }        return json_encode($data);    }    public function actionCode()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        if ($user['level_id'] >= 1) {            if (!$user['user_code']) {                $content_now = $user['code'];                $content = Yii::$app->request->hostInfo . '/index.php/index/register.html?code=' . $content_now;                ob_start();                QRcode::png($content, false, 'L', 10, 1);                $img = ob_get_contents();                ob_end_clean();                $imgInfo = 'data:image/jpeg;base64,' . chunk_split(base64_encode($img));//ת                ob_flush();                $re = Helper::base64_image_content2($imgInfo, $content_now);                $user->user_code = $re;                $user->save();            }            return $this->render('code', ['user' => $user]);        } else {            return $this->message('您还未具备推广资格', $this->redirect(Yii::$app->request->referrer));        }    }    public function actionCard()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        $model = UserCard::find()->where(['user_id' => $user['id']])->limit(1)->one();        return $this->render('card', ['user' => $user, 'model' => $model]);    }    public function actionAddress()    {        $model = Address::find()->where(['user_id' => Yii::$app->session->get('user_id')])->orderBy('is_default desc,id asc')->all();        return $this->render('address', ['model' => $model]);    }    public function actionAddAddress()    {        $url = Yii::$app->request->get('url');        if ($url) {            Yii::$app->session->set('url', $url);        }        $post = Yii::$app->request->post();        if ($post) {            $new = new Address();            $new->user_id = Yii::$app->session->get('user_id');            $new->setAttributes($post);            $new->save();            $url = Yii::$app->session->get('url');            if ($url) {                Yii::$app->session->remove('url');                return $this->redirect($url);            }            return $this->redirect(['address']);        } else {            $model = Address::find()->where(['user_id' => Yii::$app->session->get('user_id')])->orderBy('is_default desc,id asc')->all();            return $this->render('add-address', ['model' => $model]);        }    }    public function actionUpdateAddress()    {        $post = Yii::$app->request->post();        if ($post) {            $now = Address::findOne($post['id']);            if ($now->user_id != Yii::$app->session->get('user_id')) {                return $this->message('不是您的地址', $this->redirect(['address']));            }            $now->setAttributes($post);            $now->save();            $url = Yii::$app->session->get('url');            if ($url) {                Yii::$app->session->remove('url');                return $this->redirect($url);            }            return $this->redirect(['address']);        } else {            $id = Yii::$app->request->get('id');            $now = Address::findOne($id);            $model = Address::find()->where(['user_id' => Yii::$app->session->get('user_id')])->orderBy('is_default desc,id asc')->all();            return $this->render('update-address', ['model' => $model, 'now' => $now]);        }    }    public function actionDefaultAddress()    {        $id = Yii::$app->request->post('id');        $model = Address::findOne($id);        Address::updateAll(['is_default' => 0], ['user_id' => Yii::$app->session->get('user_id')]);        $model->is_default = 1;        $model->save();    }    public function actionDelete()    {        $id = Yii::$app->request->post('id');        $model = Address::findOne($id);        if ($model and $model->user_id == Yii::$app->session->get('user_id')) {            $model->delete();        }        return $this->redirect(['user/address']);    }    public function actionInfo()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        return $this->render('info', ['user' => $user]);    }    public function actionDetail()    {        $model = SetImage::findOne(Yii::$app->request->get('id'));        return $this->render('detail', ['model' => $model]);    }    public function actionSys()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        $model = SetImage::getList(['type' => 2]);        return $this->render('sys', ['user' => $user, 'model' => $model]);    }    public function actionUpdate()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        if (Yii::$app->request->post('name')) {            $user->name = Yii::$app->request->post('name');        }        if (isset($_FILES['file']['name']) && $_FILES['file']['size'] > 0) {            // 定义允许上传的文件类型            $allowedTypes = ['image/jpg', 'image/jpeg', 'image/png'];            // 定义文件上传路径            $uploadPath = 'uploads/';            // 定义文件名            $videoTmpName = $_FILES['file']['tmp_name'];            $videoSize = $_FILES['file']['size'];            $size = round($videoSize / 1024 / 1024);            if ($size > 2) {                return $this->message('请上传2M以内的图片', $this->redirect(Yii::$app->request->referrer));            }            $videoType = $_FILES['file']['type'];            $arr_name = explode('.', $_FILES['file']['name']);            $videoName = date('YmdHis') . Helper::random(6) . '.' . $arr_name[1];            // 检查文件类型            if (in_array($videoType, $allowedTypes)) {                // 移动文件到指定目录                move_uploaded_file($videoTmpName, $uploadPath . $videoName);                $a = dirname(dirname(__DIR__)) . '/web/';                $file = $a . $uploadPath . $videoName;                $user->image = '/' . $uploadPath . $videoName;            } else {                return $this->message('不允许的文件类型', $this->redirect(Yii::$app->request->referrer));            }        }        if (!$user->save()) {            $errors = $user->getFirstErrors();            return $this->message(reset($errors), $this->redirect(Yii::$app->request->referrer));        } else {            return $this->redirect(['user/index']);        }    }    public function actionMoney()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        $status = Yii::$app->request->get('status', 1);        $type = Yii::$app->request->get('type', '');        $model = UserHistory::find()->where(['user_id' => $user['id']])->andWhere(['status' => $status])->andFilterWhere(['type' => $type])->orderBy('id desc')->all();        return $this->render('money', ['model' => $model, 'user' => $user]);    }    public function actionMoney2()    {        $user = User::findOne(Yii::$app->session->get('user_id'));        $status = Yii::$app->request->get('status', 1);        $type = Yii::$app->request->get('type', '');        $model = IntLog::find()->where(['user_id' => $user['id']])->andWhere(['status' => $status])->andFilterWhere(['type' => $type])->orderBy('id desc')->all();        return $this->render('money2', ['model' => $model, 'user' => $user]);    }    public function actionAddCard()    {        $user_id = Yii::$app->session->get('user_id');        $model = UserCard::find()->where(['user_id' => $user_id])->limit(1)->one();        if (!$model) {            $model = new UserCard();            $model->user_id = $user_id;        }        $model->setAttributes(Yii::$app->request->post());        $model->save();        return $this->message('保存成功', $this->redirect(['user/index']));    }    public function actionAddApply()    {        $money = Yii::$app->request->post('money');        if ($money <= 0) {            return $this->message('金额不正确', $this->redirect(Yii::$app->request->referrer));        } else {            if($money%10!=0){                return $this->message('提现金额只能为10的倍数', $this->redirect(Yii::$app->request->referrer));            }            $type = Yii::$app->request->post('type', 1);            $re = User::add_money(Yii::$app->session->get('user_id'), $money, $type);            if ($re['error'] == 0) {                return $this->message('已发起提现申请', $this->redirect(Yii::$app->request->referrer));            } else {                return $this->message($re['message'], $this->redirect(Yii::$app->request->referrer));            }        }    }    //我的团队    public function actionGroup()    {        $level = UserLevel::find()->orderBy('id asc')->all();        $user = User::findOne(Yii::$app->session->get('user_id'));        $type = Yii::$app->request->get('type');        if ($user['level_id'] >= 1) {            $now_level = UserLevel::findOne($user['level_id']);        } else {            $now_level = UserLevel::findOne(1);        }        if (!$type) {            $type = $now_level['id'];        }        $now_type = UserLevel::findOne($type);        $group_now=UserRelation::find()->where(['FIND_IN_SET(' .$user['id'] . ',relation)'])->all();        $group_number=0;        foreach ($group_now as $k=>$v){            $now_user=User::findOne($v['user_id']);            if($now_user and $now_user['level_id']>0){                $group_number++;            }        }//        $group_number =UserRelation::find()->where(['parent_id'=>$user['id']])->count() * 1+1;        $group_user=User::find()->where(['parent_id'=>$user['id']])->andWhere(['>','level_id',0])->orderBy('id desc')->all();        $arr_user=[];        foreach ($group_user as $k=>$v){            $arr_user[]=$v['id'];        }        $time=strtotime(date('Y-m-d'));        if(count($arr_user)>0){            $group_money=Order::find()->where(['or',['user_id'=>$user['id']],['in','user_id',$arr_user]])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->sum('money');            $group_count=Order::find()->where(['or',['user_id'=>$user['id']],['in','user_id',$arr_user]])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->count()*1;            $day_money=Order::find()->where(['or',['user_id'=>$user['id']],['in','user_id',$arr_user]])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->andWhere(['>=','created_at',$time])->sum('money');            $day_count=Order::find()->where(['or',['user_id'=>$user['id']],['in','user_id',$arr_user]])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->andWhere(['>=','created_at',$time])->count()*1;        }else{            $group_money=Order::find()->where(['user_id'=>$user['id']])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->sum('money');            $group_count=Order::find()->where(['user_id'=>$user['id']])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->count()*1;            $day_money=Order::find()->where(['user_id'=>$user['id']])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->andWhere(['>=','created_at',$time])->sum('money');            $day_count=Order::find()->where(['user_id'=>$user['id']])->andWhere(['in','type',[1,3]])->andWhere(['>=','status',2])->andWhere(['>=','created_at',$time])->count()*1;        }        $money1=UserHistory::find()->where(['type'=>4,'user_id'=>$user['id']])->sum('number')*1;//管理奖        $money2=UserHistory::find()->where(['user_id'=>$user['id']])->andWhere(['in','type',[1,2]])->sum('number')*1;//推荐奖        $money3=UserHistory::find()->where(['type'=>5,'user_id'=>$user['id']])->sum('number')*1;//代理分红        $money4=UserHistory::find()->where(['type'=>6,'user_id'=>$user['id']])->sum('number')*1;//全区分红        $money5=UserHistory::find()->where(['type'=>3,'user_id'=>$user['id']])->sum('number')*1;//团队奖        $money6=UserHistory::find()->where(['type'=>10,'user_id'=>$user['id']])->sum('number')*1;//见单奖        $money7=UserHistory::find()->where(['type'=>11,'user_id'=>$user['id']])->sum('number')*1;//平级奖        $money8=UserHistory::find()->where(['type'=>12,'user_id'=>$user['id']])->sum('number')*1;//新团队奖        $type2=Yii::$app->request->get('type2');        $query=UserHistory::find()->where(['user_id'=>$user['id']]);        if($type2==1){            $query->andWhere(['in','type',[1,2]]);        }elseif ($type2==2){            $query->andWhere(['type'=>3]);        }elseif ($type2==3){            $query->andWhere(['type'=>4]);        }elseif ($type2==4){            $query->andWhere(['type'=>5]);        }elseif ($type2==5){            $query->andWhere(['type'=>6]);        }elseif ($type2==6){            $query->andWhere(['type'=>7]);        }        $history=$query->orderBy('id desc')->all();        $money_fh=0;//        if($user['level_id']>=5){//            $count_user1=User::find()->where(['level_id'=>5])->count()*1;//            $count_user2=User::find()->where(['level_id'=>6])->count()*1;//            $count_user3=User::find()->where(['level_id'=>7])->count()*1;//            if($user['level_id']==5){//                $count_money=Yii::$app->config->info2('MONEY1');//                $money_fh=ceil($count_money/($count_user1+$count_user2+$count_user3));//            }elseif ($user['level_id']==6){//                $count_money=Yii::$app->config->info2('MONEY1');//                $money_fh=ceil($count_money/($count_user1+$count_user2+$count_user3));//                $count_money=Yii::$app->config->info2('MONEY2');//                $money_fh+=ceil($count_money/($count_user2+$count_user3));//            }else{//                $count_money=Yii::$app->config->info2('MONEY1');//                $money_fh=ceil($count_money/($count_user1+$count_user2+$count_user3));//                $count_money=Yii::$app->config->info2('MONEY2');//                $money_fh+=ceil($count_money/($count_user2+$count_user3));//                $count_money=Yii::$app->config->info2('MONEY3');//                $money_fh+=ceil($count_money/$count_user3);//            }//        }        $time_now=strtotime(date('Y-m-d'));        $time_now2=strtotime(date('Y-m-01'));        $order_day=Order::find()->where(['>=','status',1])->andWhere(['>=','created_at',$time_now])->count();        $order_month=Order::find()->where(['>=','status',1])->andWhere(['>=','created_at',$time_now2])->count();        return $this->render('group', [            'user' => $user, 'level' => $level, 'now_level' => $now_level,            'type' => $type, 'now_type' => $now_type, 'group_number' => $group_number,            'money1'=>$money1,'money2'=>$money2,'history'=>$history,'group_money'=>$group_money,            'day_money'=>$day_money,'day_count'=>$day_count,'group_count'=>$group_count,'group_user'=>$group_user,            'money3'=>$money3,'money4'=>$money4,'money5'=>$money5,'money_fh'=>$money_fh,'order_day'=>$order_day,'order_month'=>$order_month,'money6'=>$money6,'money7'=>$money7,'money8'=>$money8        ]);    }    //我的点位    public function actionGroup2(){        $user = User::findOne(Yii::$app->session->get('user_id'));        $model1=UserRelation2::find()->where(['parent_id'=>$user['id']])->all();        $arr1=[];        $user_children=User::find()->where(['parent_id'=>$user['id']])->andWhere(['>=','level_id',1])->count()*1;        if($user_children>=2){            foreach ($model1 as $k=>$v){                $arr1[]=$v['user_id'];            }            $model2=UserRelation2::find()->where(['parent_id2'=>$user['id']])->all();            $model3=UserRelation2::find()->where(['parent_id'=>$user['id']])->all();            $arr2=[];            foreach ($model3 as $k2=>$v2){                $model4=UserRelation2::find()->where(['parent_id'=>$v2['user_id']])->all();                foreach ($model4 as $k3=>$v3){                    $arr2[]=$v3['user_id'];                }            }            foreach ($model2 as $k2=>$v2){                $arr2[]=$v2['user_id'];            }            $type=Yii::$app->request->get('type',1);            $children=User::find()->where(['parent_id'=>$user['id']])->andWhere(['>=','level_id',1])->all();            foreach ($children as $k=>$v){                $children_children=User::find()->where(['parent_id'=>$v['id']])->andWhere(['>=','level_id',1])->count()*1;                if($children_children>=2){                    $arr1[]=$v['id'];                }            }            $group_user=User::find()->where(['in','id',$arr1])->andWhere(['>=','level_id',1])->orderBy('id desc')->all();            $group_user2=User::find()->where(['in','id',$arr2])->andWhere(['>=','level_id',1])->orderBy('id desc')->all();            if($type==1){                $now_user=$group_user;            }else{                $now_user=$group_user2;            }        }else{            $group_user=[];            $group_user2=[];            $now_user=[];        }        return $this->render('group2',['group_user'=>$group_user,'user'=>$user,'group_user2'=>$group_user2,'now_user'=>$now_user]);    }}