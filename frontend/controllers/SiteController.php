<?phpnamespace frontend\controllers;use backend\models\Code;use backend\models\Message;use backend\models\ProvinceUser;use backend\models\UserLevel;use common\components\Helper;use frontend\models\Passwd;use frontend\models\UserLoginForm2;use Yii;use frontend\models\UserLoginForm;/** * 站点控制器 */class SiteController extends FController{    public function  init()    {        if(!Yii::$app->user->isGuest){            return $this->goHome();        }    }    public function actionError(){        $this->layout='main';        $exception = Yii::$app->errorHandler->exception;        if ($exception !== null) {            return $this->render('error', ['exception' => $exception]);        }    }    /**     * @return string|\yii\web\Response     * 登陆     */    public function actionLogin()    {        $model = new UserLoginForm();        if ($model->load(Yii::$app->request->post()) && $model->login())        {            //存储登录时间，取出上次登录时间//            Yii::$app->session['last_time']=Yii::$app->user->identity->last_time;            $user=ProvinceUser::findOne(Yii::$app->user->id);            $user->last_time=time();            $user->save();            return $this->redirect(['user/index']);        }        else        {            return $this->render('login', [                'model'  => $model,            ]);        }    }    public function actionLogin2()    {        if(Helper::isMobile()){            return $this->redirect('/mobile/index.php/site/login2.html');        }        $model = new UserLoginForm2();        if ($model->load(Yii::$app->request->post()) && $model->login())        {            //存储登录时间，取出上次登录时间//            Yii::$app->session['last_time']=Yii::$app->user->identity->last_time;            $user=ProvinceUser::findOne(Yii::$app->user->id);            $user->last_time=time();            $user->save();            return $this->redirect(['user/index']);        }        else        {            return $this->render('login2', [                'model'  => $model,            ]);        }    }    /**     *注册     */    public function actionRegister()    {        if(Helper::isMobile()){            return $this->redirect('/mobile/index.php/site/register.html');        }        $model = new ProvinceUser();        $model->setScenario('register');        if (Yii::$app->request->post())        {            $model->load(Yii::$app->request->post());            if (Yii::$app->request->isAjax) {                Yii::$app->response->format = \yii\web\Response::FORMAT_JSON;                return \yii\bootstrap\ActiveForm::validate($model);            }//            if(isset($_FILES['image'])){////                $re=Helper::upload_image('upload','image');////                if($re['error']==0){////                    $model->license=implode(',',$re['data']);////                }////            }            if($model->load(Yii::$app->request->post()) and $model->save()){                return $this->message('注册成功',$this->redirect(['login']),'success');            }else{                return $this->render('register', [                    'model'=>$model,                ]);            }        }        else        {            return $this->render('register', [                'model'  => $model,            ]);        }    }    /**     * @return \yii\web\Response     * 退出登陆     */    public function actionLogout()    {        Yii::$app->user->logout();        return $this->redirect(['index/login']);    }    public function actionPassword(){        if (Yii::$app->request->post())        {            $code=Yii::$app->request->post('code');            $username=Yii::$app->request->post('mobile');            $re=Helper::checkSMS($username,$code);            $user=ProvinceUser::findOne(['username'=>$username]);            if($user){                if($re['error']==0){                    $password=Yii::$app->request->post('password');                    $re_password=Yii::$app->request->post('re_password');                    if($password and $password==$re_password){                        $user->password_hash=$password;                        $user->save();                        return $this->message('密码修改成功',$this->redirect(['site/login']));                    }                }else{                    return $this->message($re['message'],$this->redirect(Yii::$app->request->referrer));                }            }else{                return $this->message('用户不存在',$this->redirect(Yii::$app->request->referrer));            }        }        else        {            return $this->render('password', [            ]);        }    }    public function actionSms()    {        $post = Yii::$app->request->post();        $data = [];        $data['error'] = 0;        $data['message'] = '';        $phone = $post['data'];        $model = Code::find()->where(['phone' => $phone])->one();        $number = rand(10000, 99999);        if (count($model) > 0) {            if ((time() - $model['create_time']) <= 60) {                $data['error'] = 1;                $data['message'] = '短信发送太频繁，请等待1分钟';                return json_encode($data, JSON_UNESCAPED_UNICODE);            } else {                $model['number'] = $number;                $model['phone'] = "$phone";                $model['expire_time'] = time() + 300;                $model['create_time'] = time();            }        } else {            $model = new Code();            $model['number'] = $number;            $model['phone'] = "$phone";            $model['expire_time'] = time() + 300;            $model['create_time'] = time();        }        if ($model->save()) {            $re = Helper::phpSendMessage($phone, $number);            if ($re) {                $data['error'] = 0;            } else {                $data['error'] = 1;                $data['message'] = '发送失败';            }        } else {            $data['error'] = 1;            $data['message'] = '发送失败';        }        return json_encode($data, JSON_UNESCAPED_UNICODE);    }    public function actionValidatePassword(){        Yii::$app->response->format = \yii\web\Response::FORMAT_JSON;        $model = new Passwd();   //这里要替换成自己的模型类        $model->load(Yii::$app->request->post());        return \yii\widgets\ActiveForm::validate($model);    }}